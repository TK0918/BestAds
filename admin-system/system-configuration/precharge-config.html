<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>预充配置 - BestAds Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .sidebar-item {
      position: relative;
      transition: all 0.2s ease;
    }

    .sidebar-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #667eea;
      transform: scaleY(0);
      transition: transform 0.2s ease;
    }

    .sidebar-item.active::before,
    .sidebar-item:hover::before {
      transform: scaleY(1);
    }

    .table-hover tbody tr:hover {
      background-color: #f9fafb;
    }

    .modal-backdrop {
      backdrop-filter: blur(8px);
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .mobile-menu-open {
      transform: translateX(0);
    }

    .mobile-menu-closed {
      transform: translateX(-100%);
    }

    .status-valid { background-color: #10b981; color: white; }
    .status-invalid { background-color: #ef4444; color: white; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="flex h-screen overflow-hidden">
    <!-- 侧边栏 -->
    <aside id="sidebar" class="bg-white w-64 min-h-screen shadow-lg transform transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0 mobile-menu-closed lg:mobile-menu-open fixed z-30">
      <!-- 侧边栏头部 -->
      <div class="flex items-center justify-center h-16 border-b border-gray-200">
        <div class="flex items-center">
          <div class="w-8 h-8 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-chart-line text-white text-sm"></i>
          </div>
          <span class="ml-3 text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
            BestAds Admin
          </span>
        </div>
      </div>

      <!-- 侧边栏菜单区 -->
      <div id="sidebarMenuWrapper" class="overflow-y-auto" style="max-height:calc(100vh - 64px);">
        <nav>
          <!-- 主要功能 -->
          <div class="px-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer group" onclick="toggleMenuSection('mainMenu')">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 select-none">主要功能</h3>
              <i id="mainMenuArrow" class="fas fa-chevron-down text-xs text-gray-400 group-hover:text-blue-600 transition-transform"></i>
            </div>
            <ul id="mainMenu" class="space-y-1 mb-2">
              <li><a href="../main-functions/index.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-chart-bar w-5 h-5 mr-3 text-gray-400"></i>仪表盘</a></li>
              <li><a href="../main-functions/customer-management.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-users w-5 h-5 mr-3 text-gray-400"></i>客户管理</a></li>
              <li><a href="../main-functions/agent_management.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-user-shield w-5 h-5 mr-3 text-gray-400"></i>代理管理</a></li>
              <li><a href="../main-functions/rebate-config.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-percent w-5 h-5 mr-3 text-gray-400"></i>返点配置</a></li>
            </ul>
          </div>
          <!-- FB业务管理 -->
          <div class="px-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer group" onclick="toggleMenuSection('fbMenu')">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 select-none">FB业务管理</h3>
              <i id="fbMenuArrow" class="fas fa-chevron-down text-xs text-gray-400 group-hover:text-blue-600 transition-transform"></i>
            </div>
            <ul id="fbMenu" class="space-y-1 mb-2">
              <li><a href="../fb-business/account-management.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-sync w-5 h-5 mr-3 text-gray-400"></i>账户管理</a></li>
            </ul>
          </div>
          <!-- Google业务管理 -->
          <div class="px-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer group" onclick="toggleMenuSection('googleMenu')">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 select-none">Google业务管理</h3>
              <i id="googleMenuArrow" class="fas fa-chevron-down text-xs text-gray-400 group-hover:text-blue-600 transition-transform"></i>
            </div>
            <ul id="googleMenu" class="space-y-1 mb-2">
              <li><a href="../google-business/account-management.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-sync w-5 h-5 mr-3 text-gray-400"></i>账户管理</a></li>
            </ul>
          </div>
          <!-- 其他媒体业务管理 -->
          <div class="px-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer group" onclick="toggleMenuSection('otherMediaMenu')">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 select-none">其他媒体业务管理</h3>
              <i id="otherMediaMenuArrow" class="fas fa-chevron-down text-xs text-gray-400 group-hover:text-blue-600 transition-transform"></i>
            </div>
            <ul id="otherMediaMenu" class="space-y-1 mb-2">
              <li><a href="../other-media-business/account-management.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-sync w-5 h-5 mr-3 text-gray-400"></i>账户管理</a></li>
            </ul>
          </div>
          <!-- 广告治理 -->
          <div class="px-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer group" onclick="toggleMenuSection('adMenu')">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 select-none">广告治理</h3>
              <i id="adMenuArrow" class="fas fa-chevron-down text-xs text-gray-400 group-hover:text-blue-600 transition-transform"></i>
            </div>
            <ul id="adMenu" class="space-y-1 mb-2">
              <li><a href="../ad-governance/ad-review.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-shield-alt w-5 h-5 mr-3 text-gray-400"></i>广告审核</a></li>
            </ul>
          </div>
          <!-- 系统设置 -->
          <div class="px-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer group" onclick="toggleMenuSection('sysMenu')">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 select-none">系统设置</h3>
              <i id="sysMenuArrow" class="fas fa-chevron-down text-xs text-gray-400 group-hover:text-blue-600 transition-transform"></i>
            </div>
            <ul id="sysMenu" class="space-y-1 mb-2">
              <li><a href="precharge-config.html" class="sidebar-item active flex items-center px-4 py-2 text-sm font-medium text-gray-900 rounded-lg bg-gray-100"><i class="fas fa-cog w-5 h-5 mr-3 text-gray-400"></i>系统配置</a></li>
              <li><a href="#" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-user-cog w-5 h-5 mr-3 text-gray-400"></i>用户管理</a></li>
              <li><a href="../Log/permission-audit-log.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-file-alt w-5 h-5 mr-3 text-gray-400"></i>权限审计日志</a></li>
            </ul>
          </div>
        </nav>
      </div>
    </aside>

    <!-- 遮罩层 (移动端) -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 opacity-0 hidden z-20 transition-opacity duration-300 ease-linear lg:hidden"></div>

    <!-- 主要内容区域 -->
    <div class="flex flex-col flex-1 overflow-hidden">
      <!-- 顶部栏 -->
      <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="flex items-center justify-between h-16 px-4 sm:px-6 lg:px-8">
          <!-- 左侧 -->
          <div class="flex items-center">
            <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
              <i class="fas fa-bars text-lg"></i>
            </button>
            
            <div class="ml-4 lg:ml-0">
              <nav class="flex space-x-2 text-sm" aria-label="Breadcrumb">
                <span class="text-gray-500">系统配置</span>
                <i class="fas fa-chevron-right text-gray-300 text-xs mt-0.5"></i>
                <span class="text-gray-900 font-medium">预充配置</span>
              </nav>
            </div>
          </div>
          
          <!-- 右侧 -->
          <div class="flex items-center space-x-4">
            <div class="relative">
              <button class="p-2 text-gray-400 hover:text-gray-500 relative">
                <i class="fas fa-bell text-lg"></i>
                <span class="absolute -top-1 -right-1 h-4 w-4 bg-red-500 rounded-full flex items-center justify-center text-xs text-white">3</span>
              </button>
            </div>
            
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                <span class="text-white text-sm font-medium">A</span>
              </div>
              <span class="hidden md:block text-sm font-medium text-gray-700">管理员</span>
            </div>
          </div>
        </div>
      </header>

      <!-- 页面内容 -->
      <main class="flex-1 overflow-y-auto bg-gray-50">
        <div class="py-6">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- 页面标题 -->
            <div class="mb-6">
              <h1 class="text-2xl font-bold text-gray-900">预充配置</h1>
              <p class="mt-1 text-sm text-gray-500">管理商户预充配置信息</p>
            </div>

            <!-- 筛选区域 -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">商户ID</label>
                  <input type="text" id="merchantIdFilter" placeholder="请输入商户ID" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">客户名称</label>
                  <input type="text" id="customerNameFilter" placeholder="请输入客户名称" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-end">
                  <button onclick="searchData()" class="w-full md:w-auto px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-md hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <i class="fas fa-search mr-2"></i>查询
                  </button>
                </div>
              </div>
            </div>

            <!-- 操作按钮区域 -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
              <div class="flex flex-wrap gap-3">
                <button onclick="openAddModal()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-md hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                  <i class="fas fa-plus mr-2"></i>新增
                </button>
                <button onclick="downloadTemplate()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                  <i class="fas fa-download mr-2"></i>下载模板
                </button>
                <button onclick="openBatchUploadModal()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                  <i class="fas fa-upload mr-2"></i>批量上传
                </button>
              </div>
            </div>

            <!-- 数据表格 -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-hover">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商户ID</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">客户名称</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">历史充值($)</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">历史消耗($)</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">带来总利润($)</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">利润截止日期</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">预充比例(%)</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">预充金额上限($)</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最后修改人</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最后修改时间</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                  </thead>
                  <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- 数据将通过JavaScript动态填充 -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- 新增/编辑模态框 -->
  <div id="addEditModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 modal-backdrop transition-opacity" onclick="closeAddEditModal()"></div>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full animate-fadeIn">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900" id="modalTitle">新增预充配置</h3>
            <button onclick="closeAddEditModal()" class="text-gray-400 hover:text-gray-500">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <form id="addEditForm" onsubmit="submitForm(event)">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div id="merchantSelectWrapper">
                <label class="block text-sm font-medium text-gray-700 mb-2">商户ID <span class="text-red-500">*</span></label>
                <select id="merchantId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                  <option value="">请选择商户</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">客户名称</label>
                <input type="text" id="customerName" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">历史充值($) <span class="text-red-500">*</span></label>
                <input type="number" id="historicalRecharge" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">历史消耗($) <span class="text-red-500">*</span></label>
                <input type="number" id="historicalConsumption" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">带来总利润($) <span class="text-red-500">*</span></label>
                <input type="number" id="totalProfit" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">利润截止日期 <span class="text-red-500">*</span></label>
                <input type="date" id="profitCutoffDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">预充比例(%) <span class="text-red-500">*</span></label>
                <input type="number" id="prechargeRatio" step="0.01" min="0.01" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00-100.00" required>
                <p class="mt-1 text-xs text-gray-500">范围：0.01-100.00，保留2位小数</p>
              </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
              <button type="button" onclick="closeAddEditModal()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                取消
              </button>
              <button type="submit" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-md hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                提交
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 批量上传模态框 -->
  <div id="batchUploadModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 modal-backdrop transition-opacity" onclick="closeBatchUploadModal()"></div>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full animate-fadeIn">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">批量上传</h3>
            <button onclick="closeBatchUploadModal()" class="text-gray-400 hover:text-gray-500">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <!-- 上传步骤 -->
          <div class="mb-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-medium" id="step1">1</div>
                <span class="text-sm font-medium text-gray-700">上传文件</span>
              </div>
              <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
              <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-medium" id="step2">2</div>
                <span class="text-sm font-medium text-gray-500">解析内容</span>
              </div>
              <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
              <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-medium" id="step3">3</div>
                <span class="text-sm font-medium text-gray-500">预览内容</span>
              </div>
              <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
              <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-medium" id="step4">4</div>
                <span class="text-sm font-medium text-gray-500">确认上传</span>
              </div>
            </div>
          </div>

          <!-- 上传文件区域 -->
          <div id="uploadStep" class="mb-6">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
              <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="hidden" onchange="handleFileSelect(event)">
              <label for="fileInput" class="cursor-pointer">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                <p class="text-sm text-gray-600 mb-2">点击选择文件或拖拽文件到此处</p>
                <p class="text-xs text-gray-500">支持 CSV、XLSX、XLS 格式</p>
              </label>
            </div>
            <div id="selectedFileName" class="mt-4 text-sm text-gray-600 hidden"></div>
          </div>

          <!-- 预览内容区域 -->
          <div id="previewStep" class="hidden mb-6">
            <div class="mb-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">预览数据</span>
                <div class="text-sm text-gray-600">
                  <span>总条数：<span id="totalCount" class="font-medium">0</span></span>
                  <span class="ml-4">有效条数：<span id="validCount" class="font-medium text-green-600">0</span></span>
                  <span class="ml-4">无效条数：<span id="invalidCount" class="font-medium text-red-600">0</span></span>
                </div>
              </div>
            </div>
            <div class="overflow-x-auto max-h-96 border border-gray-200 rounded-lg">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0">
                  <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">商户ID</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">客户名称</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">历史充值($)</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">历史消耗($)</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">带来总利润($)</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">利润截止日期</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">预充比例(%)</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">数据处理</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">数据有效性</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">原因</th>
                  </tr>
                </thead>
                <tbody id="previewTableBody" class="bg-white divide-y divide-gray-200">
                  <!-- 预览数据将通过JavaScript动态填充 -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- 操作按钮 -->
          <div class="flex justify-end space-x-3 mt-6">
            <button onclick="closeBatchUploadModal()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              取消
            </button>
            <button id="confirmUploadBtn" onclick="confirmUpload()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-md hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 hidden">
              确认上传
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 模拟数据
    let prechargeData = [
      {
        merchantId: 'M001',
        customerName: '客户A',
        historicalRecharge: 10000.00,
        historicalConsumption: 8500.00,
        totalProfit: 1500.00,
        profitCutoffDate: '2024-01-31',
        prechargeRatio: 15.00,
        prechargeAmountLimit: 1500.00,
        lastModifiedBy: '管理员A',
        lastModifiedTime: '2024-03-10 10:30:00'
      },
      {
        merchantId: 'M002',
        customerName: '客户B',
        historicalRecharge: 20000.00,
        historicalConsumption: 18000.00,
        totalProfit: 2000.00,
        profitCutoffDate: '2024-02-29',
        prechargeRatio: 10.00,
        prechargeAmountLimit: 2000.00,
        lastModifiedBy: '管理员B',
        lastModifiedTime: '2024-03-11 14:20:00'
      }
    ];

    // 模拟商户列表
    const merchantList = [
      { id: 'M001', name: '客户A' },
      { id: 'M002', name: '客户B' },
      { id: 'M003', name: '客户C' },
      { id: 'M004', name: '客户D' }
    ];

    let currentEditId = null;
    let selectedFile = null;
    let parsedData = [];

    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
      renderTable();
      loadMerchantOptions();
    });

    // 渲染表格
    function renderTable() {
      const tbody = document.getElementById('dataTableBody');
      const merchantIdFilter = document.getElementById('merchantIdFilter').value.trim();
      const customerNameFilter = document.getElementById('customerNameFilter').value.trim();

      let filteredData = prechargeData.filter(item => {
        const matchMerchantId = !merchantIdFilter || item.merchantId.includes(merchantIdFilter);
        const matchCustomerName = !customerNameFilter || item.customerName.includes(customerNameFilter);
        return matchMerchantId && matchCustomerName;
      });

      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="px-6 py-4 text-center text-gray-500">暂无数据</td></tr>';
        return;
      }

      tbody.innerHTML = filteredData.map(item => `
        <tr>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.merchantId}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.customerName}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(item.historicalRecharge)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(item.historicalConsumption)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(item.totalProfit)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.profitCutoffDate}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.prechargeRatio.toFixed(2)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(item.prechargeAmountLimit)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.lastModifiedBy}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.lastModifiedTime}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button onclick="openEditModal('${item.merchantId}')" class="text-blue-600 hover:text-blue-900 mr-3">编辑</button>
          </td>
        </tr>
      `).join('');
    }

    // 搜索数据
    function searchData() {
      renderTable();
    }

    // 加载商户选项
    function loadMerchantOptions() {
      const select = document.getElementById('merchantId');
      const existingMerchantIds = prechargeData.map(item => item.merchantId);
      
      merchantList.forEach(merchant => {
        if (!existingMerchantIds.includes(merchant.id)) {
          const option = document.createElement('option');
          option.value = merchant.id;
          option.textContent = `${merchant.id} - ${merchant.name}`;
          option.setAttribute('data-name', merchant.name);
          select.appendChild(option);
        }
      });
    }

    // 商户选择变化时更新客户名称
    document.getElementById('merchantId').addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const customerName = selectedOption.getAttribute('data-name') || '';
      document.getElementById('customerName').value = customerName;
    });

    // 打开新增模态框
    function openAddModal() {
      currentEditId = null;
      document.getElementById('modalTitle').textContent = '新增预充配置';
      document.getElementById('addEditForm').reset();
      document.getElementById('merchantSelectWrapper').style.display = 'block';
      document.getElementById('merchantId').required = true;
      loadMerchantOptions();
      document.getElementById('addEditModal').classList.remove('hidden');
    }

    // 打开编辑模态框
    function openEditModal(merchantId) {
      currentEditId = merchantId;
      const item = prechargeData.find(d => d.merchantId === merchantId);
      if (!item) return;

      document.getElementById('modalTitle').textContent = '编辑预充配置';
      document.getElementById('merchantId').value = item.merchantId;
      document.getElementById('customerName').value = item.customerName;
      document.getElementById('historicalRecharge').value = item.historicalRecharge;
      document.getElementById('historicalConsumption').value = item.historicalConsumption;
      document.getElementById('totalProfit').value = item.totalProfit;
      document.getElementById('profitCutoffDate').value = item.profitCutoffDate;
      document.getElementById('prechargeRatio').value = item.prechargeRatio;

      // 编辑模式下商户ID不可选择
      document.getElementById('merchantSelectWrapper').style.display = 'none';
      document.getElementById('merchantId').required = false;
      
      document.getElementById('addEditModal').classList.remove('hidden');
    }

    // 关闭新增/编辑模态框
    function closeAddEditModal() {
      document.getElementById('addEditModal').classList.add('hidden');
      document.getElementById('addEditForm').reset();
      currentEditId = null;
    }

    // 提交表单
    function submitForm(event) {
      event.preventDefault();
      
      const merchantId = document.getElementById('merchantId').value;
      const historicalRecharge = parseFloat(document.getElementById('historicalRecharge').value);
      const historicalConsumption = parseFloat(document.getElementById('historicalConsumption').value);
      const totalProfit = parseFloat(document.getElementById('totalProfit').value);
      const profitCutoffDate = document.getElementById('profitCutoffDate').value;
      const prechargeRatio = parseFloat(document.getElementById('prechargeRatio').value);

      // 验证预充比例
      if (prechargeRatio <= 0 || prechargeRatio > 100) {
        alert('预充比例必须在0.01-100.00之间');
        return;
      }

      // 保留2位小数
      const formattedRatio = Math.round(prechargeRatio * 100) / 100;

      if (currentEditId) {
        // 编辑模式
        const item = prechargeData.find(d => d.merchantId === currentEditId);
        if (item) {
          item.historicalRecharge = historicalRecharge;
          item.historicalConsumption = historicalConsumption;
          item.totalProfit = totalProfit;
          item.profitCutoffDate = profitCutoffDate;
          item.prechargeRatio = formattedRatio;
          // 自动计算预充金额上限
          item.prechargeAmountLimit = Math.round(totalProfit * formattedRatio / 100 * 100) / 100;
          item.lastModifiedBy = '当前管理员';
          item.lastModifiedTime = new Date().toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
        }
      } else {
        // 新增模式
        const customerName = document.getElementById('customerName').value;
        const existingItem = prechargeData.find(d => d.merchantId === merchantId);
        if (existingItem) {
          alert('该商户ID已存在，无法重复添加');
          return;
        }

        prechargeData.push({
          merchantId: merchantId,
          customerName: customerName,
          historicalRecharge: historicalRecharge,
          historicalConsumption: historicalConsumption,
          totalProfit: totalProfit,
          profitCutoffDate: profitCutoffDate,
          prechargeRatio: formattedRatio,
          prechargeAmountLimit: Math.round(totalProfit * formattedRatio / 100 * 100) / 100,
          lastModifiedBy: '当前管理员',
          lastModifiedTime: new Date().toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          })
        });
      }

      renderTable();
      closeAddEditModal();
      alert('保存成功');
    }

    // 下载模板
    function downloadTemplate() {
      const csvContent = '商户ID,历史充值($),历史消耗($),带来总利润($),利润截止日期,预充比例(%)\n';
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', '预充配置模板.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // 打开批量上传模态框
    function openBatchUploadModal() {
      resetBatchUploadModal();
      document.getElementById('batchUploadModal').classList.remove('hidden');
    }

    // 关闭批量上传模态框
    function closeBatchUploadModal() {
      document.getElementById('batchUploadModal').classList.add('hidden');
      resetBatchUploadModal();
    }

    // 重置批量上传模态框
    function resetBatchUploadModal() {
      selectedFile = null;
      parsedData = [];
      document.getElementById('fileInput').value = '';
      document.getElementById('selectedFileName').classList.add('hidden');
      document.getElementById('previewStep').classList.add('hidden');
      document.getElementById('confirmUploadBtn').classList.add('hidden');
      updateStep(1);
    }

    // 更新步骤
    function updateStep(step) {
      for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (i < step) {
          stepEl.className = 'w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center font-medium';
          stepEl.innerHTML = '<i class="fas fa-check text-xs"></i>';
        } else if (i === step) {
          stepEl.className = 'w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-medium';
          stepEl.textContent = i;
        } else {
          stepEl.className = 'w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-medium';
          stepEl.textContent = i;
        }
      }
    }

    // 处理文件选择
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        selectedFile = file;
        document.getElementById('selectedFileName').textContent = `已选择文件：${file.name}`;
        document.getElementById('selectedFileName').classList.remove('hidden');
        updateStep(2);
        // 自动解析文件内容
        parseFile();
      }
    }

    // 解析文件
    function parseFile() {
      if (!selectedFile) {
        alert('请先选择文件');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
          alert('文件格式错误，至少需要包含表头和数据行');
          return;
        }

        // 跳过表头
        const dataLines = lines.slice(1);
        parsedData = [];

        dataLines.forEach((line, index) => {
          const values = line.split(',');
          if (values.length < 6) return;

          const merchantId = values[0].trim();
          const historicalRecharge = parseFloat(values[1].trim()) || 0;
          const historicalConsumption = parseFloat(values[2].trim()) || 0;
          const totalProfit = parseFloat(values[3].trim()) || 0;
          const profitCutoffDate = values[4].trim();
          const prechargeRatio = parseFloat(values[5].trim()) || 0;

          // 数据验证
          const validation = validateBatchData(merchantId, historicalRecharge, historicalConsumption, totalProfit, profitCutoffDate, prechargeRatio);
          
          // 判断是新增还是覆盖
          const existingIndex = prechargeData.findIndex(d => d.merchantId === merchantId);
          const dataProcessing = existingIndex >= 0 ? '覆盖' : '新增';

          parsedData.push({
            merchantId,
            customerName: getCustomerName(merchantId),
            historicalRecharge,
            historicalConsumption,
            totalProfit,
            profitCutoffDate,
            prechargeRatio,
            dataProcessing,
            isValid: validation.isValid,
            reason: validation.reason
          });
        });

        renderPreviewTable();
        document.getElementById('previewStep').classList.remove('hidden');
        document.getElementById('confirmUploadBtn').classList.remove('hidden');
        updateStep(3);
        
        // 如果解析后没有数据，提示用户
        if (parsedData.length === 0) {
          alert('文件解析完成，但没有找到有效数据。请检查文件格式是否正确。');
        }
      };

      reader.readAsText(selectedFile, 'UTF-8');
    }

    // 验证批量数据
    function validateBatchData(merchantId, historicalRecharge, historicalConsumption, totalProfit, profitCutoffDate, prechargeRatio) {
      // 验证商户ID是否存在
      const merchantExists = merchantList.some(m => m.id === merchantId);
      if (!merchantExists) {
        return { isValid: false, reason: '商户ID不存在' };
      }

      // 验证金额数值
      if (isNaN(historicalRecharge) || isNaN(historicalConsumption) || isNaN(totalProfit)) {
        return { isValid: false, reason: '历史充值/历史消耗/带来总利润金额数值异常' };
      }

      // 验证预充比例
      if (isNaN(prechargeRatio) || prechargeRatio <= 0 || prechargeRatio > 100) {
        return { isValid: false, reason: '预充比例数值异常' };
      }

      // 验证日期格式
      const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
      if (!dateRegex.test(profitCutoffDate)) {
        return { isValid: false, reason: '利润截止日期无效' };
      }

      return { isValid: true, reason: '' };
    }

    // 获取客户名称
    function getCustomerName(merchantId) {
      const merchant = merchantList.find(m => m.id === merchantId);
      return merchant ? merchant.name : '';
    }

    // 渲染预览表格
    function renderPreviewTable() {
      const tbody = document.getElementById('previewTableBody');
      const validCount = parsedData.filter(d => d.isValid).length;
      const invalidCount = parsedData.filter(d => !d.isValid).length;

      document.getElementById('totalCount').textContent = parsedData.length;
      document.getElementById('validCount').textContent = validCount;
      document.getElementById('invalidCount').textContent = invalidCount;

      tbody.innerHTML = parsedData.map(item => `
        <tr class="${item.isValid ? '' : 'bg-red-50'}">
          <td class="px-4 py-2 text-sm text-gray-900">${item.merchantId}</td>
          <td class="px-4 py-2 text-sm text-gray-900">${item.customerName}</td>
          <td class="px-4 py-2 text-sm text-gray-900">${formatCurrency(item.historicalRecharge)}</td>
          <td class="px-4 py-2 text-sm text-gray-900">${formatCurrency(item.historicalConsumption)}</td>
          <td class="px-4 py-2 text-sm text-gray-900">${formatCurrency(item.totalProfit)}</td>
          <td class="px-4 py-2 text-sm text-gray-900">${item.profitCutoffDate}</td>
          <td class="px-4 py-2 text-sm text-gray-900">${item.prechargeRatio.toFixed(2)}</td>
          <td class="px-4 py-2 text-sm text-gray-900">${item.dataProcessing}</td>
          <td class="px-4 py-2 text-sm">
            <span class="px-2 py-1 rounded-full text-xs font-medium ${item.isValid ? 'status-valid' : 'status-invalid'}">
              ${item.isValid ? '有效' : '无效'}
            </span>
          </td>
          <td class="px-4 py-2 text-sm text-gray-900">${item.reason || '-'}</td>
        </tr>
      `).join('');
    }

    // 确认上传
    function confirmUpload() {
      const validData = parsedData.filter(d => d.isValid);
      
      if (validData.length === 0) {
        alert('没有有效数据可以上传');
        return;
      }

      validData.forEach(item => {
        const existingIndex = prechargeData.findIndex(d => d.merchantId === item.merchantId);
        const formattedRatio = Math.round(item.prechargeRatio * 100) / 100;
        
        const dataItem = {
          merchantId: item.merchantId,
          customerName: item.customerName,
          historicalRecharge: item.historicalRecharge,
          historicalConsumption: item.historicalConsumption,
          totalProfit: item.totalProfit,
          profitCutoffDate: item.profitCutoffDate,
          prechargeRatio: formattedRatio,
          prechargeAmountLimit: Math.round(item.totalProfit * formattedRatio / 100 * 100) / 100,
          lastModifiedBy: '当前管理员',
          lastModifiedTime: new Date().toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          })
        };

        if (existingIndex >= 0) {
          // 覆盖
          prechargeData[existingIndex] = dataItem;
        } else {
          // 新增
          prechargeData.push(dataItem);
        }
      });

      renderTable();
      closeBatchUploadModal();
      alert(`成功上传 ${validData.length} 条有效数据`);
    }

    // 格式化货币
    function formatCurrency(value) {
      return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(value);
    }

    // 菜单分组折叠/展开
    function toggleMenuSection(id) {
      const ul = document.getElementById(id);
      const arrow = document.getElementById(id + 'Arrow');
      if (ul.style.display === 'none') {
        ul.style.display = '';
        arrow.classList.remove('fa-chevron-right');
        arrow.classList.add('fa-chevron-down');
      } else {
        ul.style.display = 'none';
        arrow.classList.remove('fa-chevron-down');
        arrow.classList.add('fa-chevron-right');
      }
    }

    // 侧边栏切换
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      
      if (sidebar.classList.contains('mobile-menu-closed')) {
        sidebar.classList.remove('mobile-menu-closed');
        sidebar.classList.add('mobile-menu-open');
        overlay.classList.remove('hidden');
        overlay.classList.remove('opacity-0');
        overlay.classList.add('opacity-50');
      } else {
        sidebar.classList.remove('mobile-menu-open');
        sidebar.classList.add('mobile-menu-closed');
        overlay.classList.add('opacity-0');
        overlay.classList.remove('opacity-50');
        setTimeout(() => {
          overlay.classList.add('hidden');
        }, 300);
      }
    }

    // 点击遮罩层关闭侧边栏
    document.getElementById('sidebar-overlay').addEventListener('click', function() {
      toggleSidebar();
    });

    // 响应式处理
    window.addEventListener('resize', function() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      
      if (window.innerWidth >= 1024) {
        sidebar.classList.remove('mobile-menu-closed');
        sidebar.classList.add('mobile-menu-open');
        overlay.classList.add('hidden');
        overlay.classList.add('opacity-0');
        overlay.classList.remove('opacity-50');
      }
    });
  </script>
</body>
</html>

