<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>代理管理 - BestAds Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .sidebar-item {
      position: relative;
      transition: all 0.2s ease;
    }

    .sidebar-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #667eea;
      transform: scaleY(0);
      transition: transform 0.2s ease;
    }

    .sidebar-item.active::before,
    .sidebar-item:hover::before {
      transform: scaleY(1);
    }

    .table-hover tbody tr:hover {
      background-color: #f9fafb;
    }

    .modal-backdrop {
      backdrop-filter: blur(8px);
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .mobile-menu-open {
      transform: translateX(0);
    }

    .mobile-menu-closed {
      transform: translateX(-100%);
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="flex h-screen overflow-hidden">
    <!-- 侧边栏 -->
    <aside id="sidebar" class="bg-white w-64 min-h-screen shadow-lg transform transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0 mobile-menu-closed lg:mobile-menu-open fixed z-30">
      <!-- 侧边栏头部 -->
      <div class="flex items-center justify-center h-16 border-b border-gray-200">
        <div class="flex items-center">
          <div class="w-8 h-8 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-chart-line text-white text-sm"></i>
          </div>
          <span class="ml-3 text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
            BestAds Admin
          </span>
        </div>
      </div>

      <!-- 侧边栏菜单区，支持滚动和树状折叠 -->
      <div id="sidebarMenuWrapper" class="overflow-y-auto" style="max-height:calc(100vh - 64px);">
        <nav>
          <!-- 主要功能 -->
          <div class="px-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer group" onclick="toggleMenuSection('mainMenu')">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 select-none">主要功能</h3>
              <i id="mainMenuArrow" class="fas fa-chevron-down text-xs text-gray-400 group-hover:text-blue-600 transition-transform"></i>
            </div>
            <ul id="mainMenu" class="space-y-1 mb-2">
              <li><a href="index.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-chart-bar w-5 h-5 mr-3 text-gray-400"></i>仪表盘</a></li>
              <li><a href="customer-management.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-users w-5 h-5 mr-3 text-gray-400"></i>客户管理</a></li>
              <li><a href="agent_management.html" class="sidebar-item active flex items-center px-4 py-2 text-sm font-medium text-gray-900 rounded-lg bg-gray-100"><i class="fas fa-user-shield w-5 h-5 mr-3 text-gray-500"></i>代理管理</a></li>
            </ul>
          </div>
          <!-- FB业务管理 -->
          <div class="px-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer group" onclick="toggleMenuSection('fbMenu')">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 select-none">FB业务管理</h3>
              <i id="fbMenuArrow" class="fas fa-chevron-down text-xs text-gray-400 group-hover:text-blue-600 transition-transform"></i>
            </div>
            <ul id="fbMenu" class="space-y-1 mb-2">
              <li><a href="../fb-business/account-management.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-sync w-5 h-5 mr-3 text-gray-400"></i>账户管理</a></li>
              <li><a href="../fb-business/account-opening.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-plus-circle w-5 h-5 mr-3 text-gray-400"></i>开户管理</a></li>
              <li><a href="../fb-business/account-allocation.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-clipboard-list w-5 h-5 mr-3 text-gray-400"></i>账户分配</a></li>
              <li><a href="../fb-business/recharge-management.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-dollar-sign w-5 h-5 mr-3 text-gray-400"></i>账户充值</a></li>
              <li><a href="../fb-business/deduction-management.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-minus-circle w-5 h-5 mr-3 text-gray-400"></i>账户减款</a></li>
              <li><a href="../fb-business/clear-management.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-eraser w-5 h-5 mr-3 text-gray-400"></i>账户清零</a></li>
              <li><a href="../fb-business/service-fee-config.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-receipt w-5 h-5 mr-3 text-gray-400"></i>服务费配置</a></li>
            </ul>
          </div>
          <!-- 广告治理 -->
          <div class="px-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer group" onclick="toggleMenuSection('adMenu')">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 select-none">广告治理</h3>
              <i id="adMenuArrow" class="fas fa-chevron-down text-xs text-gray-400 group-hover:text-blue-600 transition-transform"></i>
            </div>
            <ul id="adMenu" class="space-y-1 mb-2">
              <li><a href="../ad-governance/ad-review.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-shield-alt w-5 h-5 mr-3 text-gray-400"></i>广告审核</a></li>
            </ul>
          </div>
          <!-- 系统设置 -->
          <div class="px-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer group" onclick="toggleMenuSection('sysMenu')">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 select-none">系统设置</h3>
              <i id="sysMenuArrow" class="fas fa-chevron-down text-xs text-gray-400 group-hover:text-blue-600 transition-transform"></i>
            </div>
            <ul id="sysMenu" class="space-y-1 mb-2">
              <li><a href="#" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-cog w-5 h-5 mr-3 text-gray-400"></i>系统配置</a></li>
              <li><a href="#" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-user-cog w-5 h-5 mr-3 text-gray-400"></i>用户管理</a></li>
            </ul>
          </div>
          <!-- 客户流水 -->
          <div class="px-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer group" onclick="toggleMenuSection('flowMenu')">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 select-none">客户流水</h3>
              <i id="flowMenuArrow" class="fas fa-chevron-down text-xs text-gray-400 group-hover:text-blue-600 transition-transform"></i>
            </div>
            <ul id="flowMenu" class="space-y-1 mb-2">
              <li><a href="../customer-transactions/transaction-detail.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-receipt w-5 h-5 mr-3 text-gray-400"></i>交易明细</a></li>
              <li><a href="../customer-transactions/online-recharge.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-credit-card w-5 h-5 mr-3 text-gray-400"></i>在线充值</a></li>
              <li><a href="../customer-transactions/offline-transfer.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-university w-5 h-5 mr-3 text-gray-400"></i>线下转账</a></li>
            </ul>
          </div>
          <!-- 报表 -->
          <div class="px-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer group" onclick="toggleMenuSection('reportMenu')">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 select-none">报表</h3>
              <i id="reportMenuArrow" class="fas fa-chevron-down text-xs text-gray-400 group-hover:text-blue-600 transition-transform"></i>
            </div>
            <ul id="reportMenu" class="space-y-1 mb-2">
              <li><a href="../reports/customer-recharge-report.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-file-invoice-dollar w-5 h-5 mr-3 text-gray-400"></i>客户打款情况</a></li>
              <li><a href="../reports/account-recharge-report.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-file-invoice-dollar w-5 h-5 mr-3 text-gray-400"></i>广告账户充值报表</a></li>
              <li><a href="../reports/account-consume-report.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-chart-line w-5 h-5 mr-3 text-gray-400"></i>广告消耗情况</a></li>
              <li><a href="../reports/negative-ad-report.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-exclamation-triangle w-5 h-5 mr-3 text-gray-400"></i>负向广告报表</a></li>
              <li><a href="../reports/report1.html" class="sidebar-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900"><i class="fas fa-trophy w-5 h-5 mr-3 text-yellow-400"></i>运营日报</a></li>
            </ul>
          </div>
        </nav>
      </div>
      <script>
        function toggleMenuSection(id) {
          const ul = document.getElementById(id);
          const arrow = document.getElementById(id + 'Arrow');
          if (ul.style.display === 'none') {
            ul.style.display = '';
            arrow.classList.remove('fa-chevron-right');
            arrow.classList.add('fa-chevron-down');
          } else {
            ul.style.display = 'none';
            arrow.classList.remove('fa-chevron-down');
            arrow.classList.add('fa-chevron-right');
          }
        }
      </script>
    </aside>

    <!-- 遮罩层 (移动端) -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 opacity-0 hidden z-20 transition-opacity duration-300 ease-linear lg:hidden"></div>

    <!-- 主要内容区域 -->
    <div class="flex flex-col flex-1 overflow-hidden">
      <!-- 顶部栏 -->
      <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="flex items-center justify-between h-16 px-4 sm:px-6 lg:px-8">
          <!-- 左侧 -->
          <div class="flex items-center">
            <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
              <i class="fas fa-bars text-lg"></i>
            </button>
            
            <div class="ml-4 lg:ml-0">
              <nav class="flex space-x-2 text-sm" aria-label="Breadcrumb">
                <span class="text-gray-500">主页</span>
                <i class="fas fa-chevron-right text-gray-300 text-xs mt-0.5"></i>
                <span class="text-gray-900 font-medium">代理管理</span>
              </nav>
            </div>
          </div>
          
          <!-- 右侧 -->
          <div class="flex items-center space-x-4">
            <div class="relative">
              <button class="p-2 text-gray-400 hover:text-gray-500 relative">
                <i class="fas fa-bell text-lg"></i>
                <span class="absolute -top-1 -right-1 h-4 w-4 bg-red-500 rounded-full flex items-center justify-center text-xs text-white">3</span>
              </button>
            </div>
            
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                <span class="text-white text-sm font-medium">A</span>
              </div>
              <span class="hidden md:block text-sm font-medium text-gray-700">管理员</span>
            </div>
          </div>
        </div>
      </header>

      <!-- 页面内容 -->
      <main class="flex-1 overflow-y-auto bg-gray-50">
        <div class="py-6">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- 页面标题区域 -->
            <div class="mb-8">
              <div class="md:flex md:items-center md:justify-between">
                <div class="flex-1 min-w-0">
                  <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                    代理管理
                  </h2>
                  <p class="mt-1 text-sm text-gray-500">
                    管理代理信息的录入与编辑
                  </p>
                </div>
                <div class="mt-4 flex md:mt-0 md:ml-4 space-x-3">
                  <button onclick="updateAllBalances()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center space-x-2">
                    <i class="fas fa-sync-alt"></i>
                    <span>更新全部余额</span>
                  </button>
                  <button onclick="openAddAgent()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span>新增代理</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- 列表表格 -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden">
              <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">代理列表</h3>
                <div class="text-sm text-gray-500">
                  共 <span class="font-medium text-gray-900" id="agentCount">0</span> 个代理
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-hover">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代理名称</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代理英文名</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">业务对接方式</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">服务费率</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">费率状态</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代理余额</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">余额更新时间</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">余额提醒</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">提醒间隔</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">更新时间</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">修改人</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200" id="agentTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- 新增代理模态框 -->
  <div id="addAgentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal-backdrop hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full animate-fadeIn">
        <div class="px-6 py-4 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-medium text-gray-900">新增代理</h3>
            <button onclick="closeModal('addAgentModal')" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <form class="px-6 py-4" onsubmit="submitAddAgent(event)">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">代理名称 *</label>
              <input type="text" name="agentName" placeholder="请输入代理名称" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">代理英文名 *</label>
              <input type="text" name="agentNameEn" placeholder="请输入代理英文名" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">业务对接方式 *</label>
              <select name="integrationType" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="api">代理API</option>
                <option value="system">代理系统</option>
                <option value="platform">官方API</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">代理服务费率(%) *</label>
              <input type="number" name="serviceFee" step="0.01" min="0" max="100" placeholder="请输入服务费率" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">服务费率状态 *</label>
              <select name="feeStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="active">启用</option>
                <option value="inactive">停用</option>
              </select>
            </div>
          </div>
          
          <!-- 余额提醒设置 -->
          <div class="mt-6 border-t border-gray-200 pt-6">
            <h4 class="text-lg font-medium text-gray-900 mb-4">余额提醒设置</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <div class="flex items-center">
                  <input type="checkbox" name="balanceReminderEnabled" id="balanceReminderEnabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                  <label for="balanceReminderEnabled" class="ml-2 block text-sm font-medium text-gray-700">
                    启用余额提醒
                  </label>
                </div>
              </div>
              <div id="reminderSettings" class="md:col-span-2 hidden">
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2">提醒间隔 *</label>
                  <select name="reminderInterval" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="hourly">每小时</option>
                    <option value="2hours">每2小时</option>
                    <option value="4hours">每4小时</option>
                    <option value="6hours">每6小时</option>
                    <option value="12hours">每12小时</option>
                    <option value="daily">每天</option>
                  </select>
                </div>
                
                <div class="mb-4">
                  <div class="flex items-center justify-between mb-3">
                    <label class="block text-sm font-medium text-gray-700">余额提醒阈值范围 *</label>
                    <button type="button" onclick="addThresholdRange('add')" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                      <i class="fas fa-plus mr-1"></i>
                      添加范围
                    </button>
                  </div>
                  <div id="thresholdRanges" class="space-y-3">
                    <!-- 默认范围 -->
                    <div class="threshold-range border border-gray-200 rounded-lg p-3 bg-gray-50">
                      <div class="flex items-center space-x-3">
                        <div class="flex-1">
                          <label class="block text-xs font-medium text-gray-600 mb-1">上限 (小于等于)</label>
                          <input type="number" name="rangeMaxs[]" step="0.01" min="0" placeholder="100000" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div class="flex-1">
                          <label class="block text-xs font-medium text-gray-600 mb-1">下限 (大于)</label>
                          <input type="number" name="rangeMins[]" step="0.01" min="0" placeholder="50000" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div class="flex items-end">
                          <button type="button" onclick="removeThresholdRange(this)" class="text-red-600 hover:text-red-800 p-1">
                            <i class="fas fa-trash text-sm"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">提示：可以设置多个余额范围，当余额落入某个范围时会发送提醒通知</p>
                </div>
              </div>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="closeModal('addAgentModal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors duration-200">取消</button>
            <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 transition-colors duration-200">确认新增</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 编辑代理模态框 -->
  <div id="editAgentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal-backdrop hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full animate-fadeIn">
        <div class="px-6 py-4 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-medium text-gray-900">编辑代理信息</h3>
            <button onclick="closeModal('editAgentModal')" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <form class="px-6 py-4" onsubmit="submitEditAgent(event)">
          <input type="hidden" name="agentId">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">代理名称 *</label>
              <input type="text" name="agentName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">代理英文名 *</label>
              <input type="text" name="agentNameEn" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">业务对接方式 *</label>
              <select name="integrationType" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="api">代理API</option>
                <option value="system">代理系统</option>
                <option value="platform">官方API</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">代理服务费率(%) *</label>
              <input type="number" name="serviceFee" step="0.01" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">服务费率状态 *</label>
              <select name="feeStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="active">启用</option>
                <option value="inactive">停用</option>
              </select>
            </div>
          </div>
          
          <!-- 余额提醒设置 -->
          <div class="mt-6 border-t border-gray-200 pt-6">
            <h4 class="text-lg font-medium text-gray-900 mb-4">余额提醒设置</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <div class="flex items-center">
                  <input type="checkbox" name="balanceReminderEnabled" id="editBalanceReminderEnabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                  <label for="editBalanceReminderEnabled" class="ml-2 block text-sm font-medium text-gray-700">
                    启用余额提醒
                  </label>
                </div>
              </div>
              <div id="editReminderSettings" class="md:col-span-2 hidden">
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2">提醒间隔 *</label>
                  <select name="reminderInterval" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="hourly">每小时</option>
                    <option value="2hours">每2小时</option>
                    <option value="4hours">每4小时</option>
                    <option value="6hours">每6小时</option>
                    <option value="12hours">每12小时</option>
                    <option value="daily">每天</option>
                  </select>
                </div>
                
                <div class="mb-4">
                  <div class="flex items-center justify-between mb-3">
                    <label class="block text-sm font-medium text-gray-700">余额提醒阈值范围 *</label>
                    <button type="button" onclick="addThresholdRange('edit')" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                      <i class="fas fa-plus mr-1"></i>
                      添加范围
                    </button>
                  </div>
                  <div id="editThresholdRanges" class="space-y-3">
                    <!-- 默认范围 -->
                    <div class="threshold-range border border-gray-200 rounded-lg p-3 bg-gray-50">
                      <div class="flex items-center space-x-3">
                        <div class="flex-1">
                          <label class="block text-xs font-medium text-gray-600 mb-1">上限 (小于等于)</label>
                          <input type="number" name="rangeMaxs[]" step="0.01" min="0" placeholder="100000" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div class="flex-1">
                          <label class="block text-xs font-medium text-gray-600 mb-1">下限 (大于)</label>
                          <input type="number" name="rangeMins[]" step="0.01" min="0" placeholder="50000" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div class="flex items-end">
                          <button type="button" onclick="removeThresholdRange(this)" class="text-red-600 hover:text-red-800 p-1">
                            <i class="fas fa-trash text-sm"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">提示：可以设置多个余额范围，当余额落入某个范围时会发送提醒通知</p>
                </div>
              </div>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="closeModal('editAgentModal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors duration-200">取消</button>
            <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 transition-colors duration-200">保存修改</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // 模拟数据
    let agentsData = [
      { 
        id: 'A001', 
        agentName: '蓝标', 
        agentNameEn: 'Madhouse', 
        integrationType: 'api', 
        serviceFee: 3.50, 
        feeStatus: 'active', 
        balance: 12500.50,
        balanceUpdateTime: '2025-01-15 14:30',
        balanceReminderEnabled: true,
        reminderThresholds: [
          { min: 0, max: 9999 },
          { min: 10000, max: 19999 },
          { min: 20000, max: 49999 },
          { min: 50000, max: 99999 },
          { min: 100000, max: 999999 }
        ],
        reminderInterval: 'daily',
        updateTime: '2025-08-01 10:00', 
        updatedBy: '管理员' 
      },
      { 
        id: 'A002', 
        agentName: '省广', 
        agentNameEn: 'MIGC', 
        integrationType: 'system', 
        serviceFee: 2.00, 
        feeStatus: 'inactive', 
        balance: 8500.00,
        balanceUpdateTime: '2025-01-15 09:15',
        balanceReminderEnabled: false,
        reminderThresholds: [],
        reminderInterval: 'daily',
        updateTime: '2025-08-10 14:20', 
        updatedBy: '李四' 
      }
    ];

    const integrationTypeMap = { api: '代理API', system: '代理系统', platform: '官方API' };
    const feeStatusMap = { active: '启用', inactive: '停用' };
    const reminderIntervalMap = { 
      hourly: '每小时', 
      '2hours': '每2小时', 
      '4hours': '每4小时', 
      '6hours': '每6小时', 
      '12hours': '每12小时', 
      daily: '每天' 
    };

    document.addEventListener('DOMContentLoaded', () => {
      renderAgentTable();
      
      // 添加余额提醒开关事件监听器
      document.getElementById('balanceReminderEnabled').addEventListener('change', function() {
        toggleReminderSettings('reminderSettings', this.checked);
      });
      
      document.getElementById('editBalanceReminderEnabled').addEventListener('change', function() {
        toggleReminderSettings('editReminderSettings', this.checked);
      });
    });

    function renderAgentTable() {
      const tbody = document.getElementById('agentTableBody');
      tbody.innerHTML = '';
      document.getElementById('agentCount').textContent = agentsData.length;
      agentsData.forEach(agent => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${agent.agentName}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${agent.agentNameEn}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${integrationTypeMap[agent.integrationType] || agent.integrationType}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${agent.serviceFee}%</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${agent.feeStatus === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
              ${feeStatusMap[agent.feeStatus] || agent.feeStatus}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">¥${agent.balance.toLocaleString()}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${agent.balanceUpdateTime}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${agent.balanceReminderEnabled ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
              ${agent.balanceReminderEnabled ? '启用' : '停用'}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${agent.balanceReminderEnabled ? reminderIntervalMap[agent.reminderInterval] : '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${agent.updateTime}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${agent.updatedBy}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button class="text-blue-600 hover:text-blue-900 bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded text-xs transition-colors duration-200" onclick="openEditAgent('${agent.id}')">编辑</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function openAddAgent() {
      document.getElementById('addAgentModal').classList.remove('hidden');
    }

    function openEditAgent(agentId) {
      const agent = agentsData.find(a => a.id === agentId);
      if (!agent) return;
      const form = document.querySelector('#editAgentModal form');
      form.agentId.value = agent.id;
      form.agentName.value = agent.agentName;
      form.agentNameEn.value = agent.agentNameEn;
      form.integrationType.value = agent.integrationType;
      form.serviceFee.value = agent.serviceFee;
      form.feeStatus.value = agent.feeStatus;
      
      // 设置余额提醒相关字段
      form.balanceReminderEnabled.checked = agent.balanceReminderEnabled;
      form.reminderInterval.value = agent.reminderInterval || 'daily';
      
      // 清空并重新填充阈值范围
      const container = document.getElementById('editThresholdRanges');
      container.innerHTML = '';
      
      if (agent.balanceReminderEnabled && agent.reminderThresholds && agent.reminderThresholds.length > 0) {
        agent.reminderThresholds.forEach((range, index) => {
          const rangeDiv = document.createElement('div');
          rangeDiv.className = 'threshold-range border border-gray-200 rounded-lg p-3 bg-gray-50';
          rangeDiv.innerHTML = `
            <div class="flex items-center space-x-3">
              <div class="flex-1">
                <label class="block text-xs font-medium text-gray-600 mb-1">上限 (小于等于)</label>
                <input type="number" name="rangeMaxs[]" value="${range.max}" step="0.01" min="0" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
              </div>
              <div class="flex-1">
                <label class="block text-xs font-medium text-gray-600 mb-1">下限 (大于)</label>
                <input type="number" name="rangeMins[]" value="${range.min}" step="0.01" min="0" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
              </div>
              <div class="flex items-end">
                <button type="button" onclick="removeThresholdRange(this)" class="text-red-600 hover:text-red-800 p-1">
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>
            </div>
          `;
          container.appendChild(rangeDiv);
        });
      } else {
        // 添加一个默认范围
        addThresholdRange('edit');
      }
      
      // 显示或隐藏提醒设置
      toggleReminderSettings('editReminderSettings', agent.balanceReminderEnabled);
      
      document.getElementById('editAgentModal').classList.remove('hidden');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    function toggleReminderSettings(settingsId, enabled) {
      const settings = document.getElementById(settingsId);
      if (enabled) {
        settings.classList.remove('hidden');
        // 设置必填属性
        const intervalSelect = settings.querySelector('select[name="reminderInterval"]');
        if (intervalSelect) intervalSelect.required = true;
      } else {
        settings.classList.add('hidden');
        // 移除必填属性
        const intervalSelect = settings.querySelector('select[name="reminderInterval"]');
        if (intervalSelect) intervalSelect.required = false;
      }
    }

    function addThresholdRange(modalType) {
      const containerId = modalType === 'edit' ? 'editThresholdRanges' : 'thresholdRanges';
      const container = document.getElementById(containerId);
      
      const rangeDiv = document.createElement('div');
      rangeDiv.className = 'threshold-range border border-gray-200 rounded-lg p-3 bg-gray-50';
      rangeDiv.innerHTML = `
        <div class="flex items-center space-x-3">
          <div class="flex-1">
            <label class="block text-xs font-medium text-gray-600 mb-1">上限 (小于等于)</label>
            <input type="number" name="rangeMaxs[]" step="0.01" min="0" placeholder="100000" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
          </div>
          <div class="flex-1">
            <label class="block text-xs font-medium text-gray-600 mb-1">下限 (大于)</label>
            <input type="number" name="rangeMins[]" step="0.01" min="0" placeholder="50000" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
          </div>
          <div class="flex items-end">
            <button type="button" onclick="removeThresholdRange(this)" class="text-red-600 hover:text-red-800 p-1">
              <i class="fas fa-trash text-sm"></i>
            </button>
          </div>
        </div>
      `;
      
      container.appendChild(rangeDiv);
    }

    function removeThresholdRange(button) {
      const rangeDiv = button.closest('.threshold-range');
      const container = rangeDiv.parentNode;
      
      // 至少保留一个范围
      if (container.children.length > 1) {
        rangeDiv.remove();
      } else {
        showToast('至少需要保留一个阈值范围');
      }
    }

    function submitAddAgent(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const balanceReminderEnabled = formData.get('balanceReminderEnabled') === 'on';
      
      // 处理多阈值范围
      const reminderThresholds = [];
      if (balanceReminderEnabled) {
        const rangeMaxs = formData.getAll('rangeMaxs[]');
        const rangeMins = formData.getAll('rangeMins[]');
        
        for (let i = 0; i < rangeMaxs.length; i++) {
          if (rangeMaxs[i] && rangeMins[i]) {
            reminderThresholds.push({
              min: parseFloat(rangeMins[i]),
              max: parseFloat(rangeMaxs[i])
            });
          }
        }
      }
      
      const newAgent = {
        id: 'A' + String(Math.floor(Math.random() * 9000) + 1000),
        agentName: formData.get('agentName'),
        agentNameEn: formData.get('agentNameEn'),
        integrationType: formData.get('integrationType'),
        serviceFee: parseFloat(formData.get('serviceFee')),
        feeStatus: formData.get('feeStatus'),
        balance: 0,
        balanceUpdateTime: new Date().toLocaleString('zh-CN'),
        balanceReminderEnabled: balanceReminderEnabled,
        reminderThresholds: reminderThresholds,
        reminderInterval: balanceReminderEnabled ? formData.get('reminderInterval') : 'daily',
        updateTime: new Date().toLocaleString('zh-CN'),
        updatedBy: '管理员'
      };
      agentsData.unshift(newAgent);
      renderAgentTable();
      closeModal('addAgentModal');
      event.target.reset();
      showToast('代理添加成功');
    }

    function submitEditAgent(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const id = formData.get('agentId');
      const balanceReminderEnabled = formData.get('balanceReminderEnabled') === 'on';
      
      // 处理多阈值范围
      const reminderThresholds = [];
      if (balanceReminderEnabled) {
        const rangeMaxs = formData.getAll('rangeMaxs[]');
        const rangeMins = formData.getAll('rangeMins[]');
        
        for (let i = 0; i < rangeMaxs.length; i++) {
          if (rangeMaxs[i] && rangeMins[i]) {
            reminderThresholds.push({
              min: parseFloat(rangeMins[i]),
              max: parseFloat(rangeMaxs[i])
            });
          }
        }
      }
      
      const idx = agentsData.findIndex(a => a.id === id);
      if (idx !== -1) {
        agentsData[idx].agentName = formData.get('agentName');
        agentsData[idx].agentNameEn = formData.get('agentNameEn');
        agentsData[idx].integrationType = formData.get('integrationType');
        agentsData[idx].serviceFee = parseFloat(formData.get('serviceFee'));
        agentsData[idx].feeStatus = formData.get('feeStatus');
        agentsData[idx].balanceReminderEnabled = balanceReminderEnabled;
        agentsData[idx].reminderThresholds = reminderThresholds;
        agentsData[idx].reminderInterval = balanceReminderEnabled ? formData.get('reminderInterval') : 'daily';
        agentsData[idx].updateTime = new Date().toLocaleString('zh-CN');
        agentsData[idx].updatedBy = '管理员';
      }
      renderAgentTable();
      closeModal('editAgentModal');
      showToast('代理信息已更新');
    }

    // 侧边栏切换
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      
      if (sidebar.classList.contains('mobile-menu-closed')) {
        sidebar.classList.remove('mobile-menu-closed');
        sidebar.classList.add('mobile-menu-open');
        overlay.classList.remove('hidden');
        overlay.classList.remove('opacity-0');
        overlay.classList.add('opacity-50');
      } else {
        sidebar.classList.remove('mobile-menu-open');
        sidebar.classList.add('mobile-menu-closed');
        overlay.classList.add('opacity-0');
        overlay.classList.remove('opacity-50');
        setTimeout(() => {
          overlay.classList.add('hidden');
        }, 300);
      }
    }

    // 点击遮罩层关闭侧边栏
    document.getElementById('sidebar-overlay').addEventListener('click', function() {
      toggleSidebar();
    });

    // 菜单项切换高亮
    document.querySelectorAll('.sidebar-item').forEach(item => {
      item.addEventListener('click', function(e) {
        if (this.getAttribute('href') === '#') {
          e.preventDefault();
        }
        document.querySelectorAll('.sidebar-item').forEach(menu => menu.classList.remove('active'));
        this.classList.add('active');
      });
    });

    function updateAllBalances() {
      // 显示加载状态
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>更新中...</span>';
      button.disabled = true;
      
      // 模拟API调用延迟
      setTimeout(() => {
        const currentTime = new Date().toLocaleString('zh-CN');
        
        // 更新所有代理的余额（模拟从API获取最新余额）
        agentsData.forEach(agent => {
          // 模拟不同的余额变化
          const randomChange = (Math.random() - 0.5) * 2000; // -1000 到 +1000 的随机变化
          agent.balance = Math.max(0, agent.balance + randomChange);
          agent.balanceUpdateTime = currentTime;
        });
        
        // 重新渲染表格
        renderAgentTable();
        
        // 恢复按钮状态
        button.innerHTML = originalText;
        button.disabled = false;
        
        // 显示成功提示
        showToast('所有代理余额已更新');
      }, 1500);
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 right-4 z-50 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto transform transition-all duration-300 translate-x-full';
      toast.innerHTML = `
        <div class="rounded-lg shadow-lg border-l-4 border-green-400 p-4 text-green-700">
          <div class="flex items-start">
            <i class="fas fa-check-circle mt-0.5"></i>
            <div class="ml-3 text-sm font-medium">${message}</div>
            <button onclick="this.closest('.fixed').remove()" class="ml-auto text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.remove('translate-x-full'), 50);
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>

